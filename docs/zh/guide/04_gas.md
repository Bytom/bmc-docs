## Gas费用

本教程将为您介绍 BMC 中的 Gas相关内容。

#### 什么是Gas？

Gas 是指在BMC上执行特定操作所需的计算工作量。

由于每笔交易都需要计算资源才能执行，所以每笔交易都需要付费，Gas 就是是指成功进行交易所需的费用。（*注：BMC 上的 Gas 需要使用 BTM 支付，BTM 的精度为10^-18^*）

#### 为什么存在Gas？

Gas 费用有助于确保BMC网络安全。 在网络上执行的每次计算都需要收费，这样可以防止参与者对网络造成垃圾信息。 为了防止代码中无意、恶意的无限循环或其他计算浪费，要求每个事务对代码可以执行的计算步骤设置一个限制。

#### Gas计算规则

每个区块都有基本费，由网络根据区块空间需求来计算每单位 gas 最低价格。 由于交易费的基本费会被燃烧掉，因此用户还要在其交易中设定一个小费（优先费）。 小费用于满足矿工执行和广播包含用户交易的区块，预计将由大多数钱包自动设置。

交易总费用的计算用如下所示：`Gas 单位 (限额) * (基本费用 + 小费)`

假设 Jordan 需要向 Taylor 支付 1 BTM。 在交易中，矿工报酬限额为 21,000 单位，基本费用的价格是 100 *10^-18^ BTM。 Jordan 支付了 10 *10^-18^ BTM作为小费。

使用上面的公式，我们可以计算 `21,000 * (100 + 10) = 0.00231 BTM` 。

当 Jordan 转账时，将从 Jordan 账户中扣除 1.00231 BTM。 Taylor 将获得 1.0000 BTM。 矿工得到 0.00021 BTM。 0.0021 BTM 的基本费用被燃烧。

 此外，Jordan 还可以为交易设定最高费用 (`maxFeePergas`)。 最高费用与实际收费之间的差额将归还给 Jordan。如： `退款 = 最高费用 - (基本费用 + 优先费)`。 Jordan 可以为执行交易费用设定一个最高金额，而不必担心在执行交易时“超额”支付基本费用。 

 ##### 区块大小

区块的大小是可以改变的，每个区块的目标大小为 1500 万 gas，但区块的大小将根据网络需求增减。最多到 3000 万 gas 的区块限制（目标区块大小的 2 倍）。 该协议通过 *tâtonnement* 的过程使区块大小平均达到 1,500 万。 这意味着如果区块大小超出目标区块大小，协议将增加以下区块的基本费用。 同样，如果区块大小低于目标区块大小，协议将减少基本费用。 基本费用的调整金额与当前区块大小和目标区块大小的差距是成比例。 

##### 基本费用

每个区块都有作为储备价格的基本费用。 要想有资格被列入区块，gas 费用报价必须至少等于基本费用。 基本费用独立于当前区块计算，是由区块之前的区块决定的，这使得用户更容易预测交易费用。 当区块被开采时，此基本费用将被“燃烧掉”，从循环中移除。

基本费用的计算公式是将上一个区块的大小（所有交易中使用的 gas 数量）与目标大小进行比较。 如果超过目标区块大小，区块的基本费用将最多增加 12.5%。 这种指数级增长使得区块大小无限期保持高位在经济上不可行。

| 区块编号 | 已包含 Gas | 费用增加 | 当前基本费用 |
| :------- | :--------- | :------- | :----------- |
| 1        | 15M        | 0%       | 100 *10 ^-9^ BTM    |
| 2        | 30M        | 0%       | 100 *10 ^-9^ BTM    |
| 3        | 30M        | 12.5%    | 112.5 *10 ^-9^ BTM  |
| 4        | 30M        | 12.5%    | 126.6 *10 ^-9^ BTM  |
| 5        | 30M        | 12.5%    | 142.4 *10 ^-9^ BTM  |
| 6        | 30M        | 12.5%    | 160.2 *10 ^-9^ BTM  |
| 7        | 30M        | 12.5%    | 180.2 *10 ^-9^ BTM  |
| 8        | 30M        | 12.5%    | 202.7 *10 ^-9^ BTM  |

##### 优先费（小费）

小费的存在是为了激励矿工将交易纳入区块。 如果没有小费，矿工会发现开采空区块在经济上可行，因为他们会获得相同的区块奖励。 在常规情况下，一笔金额不大的小费给矿工提供了包含该交易的最低激励。 对于需要在同一区块中优先执行的交易，需要更高的小费来试图出价高于竞争交易。

##### 最高费用

要在网络上执行交易，用户可以为他们愿意支付的交易执行费指定最高限额。 此可选参数称为 `maxFeePergas`。 为了执行交易，最高费用必须超过基本费用和小费的总和， 如果有余额，也会为交易发送人退还最高费用与基本费用和小费总和之间的差额。

##### EIP-1559

Gas费用机制满足  [EIP-1559](https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1559.md) 。用户可以在提交交易时设定 `maxFeePergas`，表示他们愿意为执行交易支付多少费用，同时清楚该数额不会超过 gas 的市场价格 (`BaseFeePergas`)，并且获得减去小费后的剩余退款。 

#### 什么是 GAS 限额？

Gas 限额是指您愿意在交易中消耗的最大 gas 数量。 涉及智能合约的更复杂交易需要更多的计算工作，因此相比较简单的支付，它们需要更高的 gas 限额。 标准的 BTM 转账一般要求 gas 的限额为 21,000 单位。

例如，如果您对简单的 BTM 转账设置 50,000 gas 限额。EVM 将消耗 21,000，您将收到剩余的 29,000。 然而，如果您设置的 gas 太少，比如说，对于简单的 BTM 转账，gas 限额为 20,000。EVM 将消耗您 20,000 gas 试图实现交易，但不会完成。 然后，EVM 会恢复所有变化，但由于矿工已经完成了价值 20k gas 的工作，所以 gas 被消耗掉了。







